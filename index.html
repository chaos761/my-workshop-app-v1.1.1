<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Project Time Tracker (Offline)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Add Babel for in-browser JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Add React and ReactDOM from CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<style>
  @keyframes blob {
    0% { transform: translate(0px, 0px) scale(1); }
    33% { transform: translate(30px, -50px) scale(1.1); }
    66% { transform: translate(-20px, 20px) scale(0.9); }
    100% { transform: translate(0px, 0px) scale(1); }
  }
  @keyframes pop-in {
    0% { transform: scale(0.95); opacity: 0.8; }
    100% { transform: scale(1); opacity: 1; }
  }
  @keyframes pulse-border {
    0%, 100% { border-color: transparent; }
    50% { border-color: var(--pulse-color); }
  }
  .animate-blob {
    animation: blob 8s infinite ease-in-out;
  }
  .animate-pop-in {
    animation: pop-in 0.3s ease-out;
  }
  .animate-pulse-border {
    animation: pulse-border 2s infinite ease-in-out;
  }
  .animation-delay-2000 { animation-delay: -2s; }
  .animation-delay-4000 { animation-delay: -4s; }
</style>
<script type="importmap">
{
  "imports": {
    "react/": "https://aistudiocdn.com/react@^19.1.1/",
    "react": "https://aistudiocdn.com/react@^19.1.1",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.1.1/"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
<body class="bg-[#e0e5ec] overflow-hidden">
    <div class="absolute top-0 -left-4 w-72 h-72 bg-purple-300 rounded-full mix-blend-hard-light filter blur-2xl opacity-70 animate-blob"></div>
    <div class="absolute top-0 -right-4 w-72 h-72 bg-yellow-300 rounded-full mix-blend-hard-light filter blur-2xl opacity-70 animate-blob animation-delay-2000"></div>
    <div class="absolute bottom-0 -left-20 w-72 h-72 bg-pink-300 rounded-full mix-blend-hard-light filter blur-2xl opacity-70 animate-blob animation-delay-4000"></div>
    <div id="root" class="relative z-10"></div>
    <!-- The entire application logic is now inside this script tag -->
    <script type="text/babel">
// All JS/TSX files are combined here. React and ReactDOM are available globally from the CDN scripts.
const { useState, useEffect, useMemo, useCallback, useRef, StrictMode } = React;

// --- From types.ts ---
const TimerStatus = {
  Stopped: 0,
  Running: 1,
  Paused: 2,
};

// --- From utils.ts ---
const formatTime = (totalSeconds) => {
  const hours = Math.floor(totalSeconds / 3600);
  const minutes = Math.floor((totalSeconds % 3600) / 60);
  const seconds = totalSeconds % 60;
  return [hours, minutes, seconds]
    .map(v => v.toString().padStart(2, '0'))
    .join(':');
};

const calculateTotalTime = (project) => {
    if (!project || !project.timeContributions) return 0;
    return Object.values(project.timeContributions).reduce((sum, time) => sum + time, 0);
};

// --- From hooks/useLocalStorage.ts ---
function useLocalStorage(key, initialValue) {
  const [storedValue, setStoredValue] = useState(() => {
    try {
      const item = window.localStorage.getItem(key);
      return item ? JSON.parse(item) : initialValue;
    } catch (error) {
      console.error(error);
      return initialValue;
    }
  });

  useEffect(() => {
    try {
      const item = window.localStorage.getItem(key);
      setStoredValue(item ? JSON.parse(item) : initialValue);
    } catch (error) {
      console.error(error);
      setStoredValue(initialValue);
    }
  }, [key]);

  const setValue = useCallback((value) => {
    try {
      setStoredValue(prevStoredValue => {
          const valueToStore = value instanceof Function ? value(prevStoredValue) : value;
          window.localStorage.setItem(key, JSON.stringify(valueToStore));
          return valueToStore;
      });
    } catch (error) {
      console.error(error);
    }
  }, [key]);

  useEffect(() => {
    const handleStorageChange = (e) => {
      if (e.key === key) {
        try {
            if (e.newValue) {
                setStoredValue(JSON.parse(e.newValue));
            } else {
                setStoredValue(initialValue);
            }
        } catch(error) {
            console.error('Error parsing storage change', error);
        }
      }
    };

    window.addEventListener('storage', handleStorageChange);

    return () => {
      window.removeEventListener('storage', handleStorageChange);
    };
  }, [key, initialValue]);

  return [storedValue, setValue];
}

// --- From components/icons.tsx ---
const ICONS = {
    PLAY: <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className="w-6 h-6"><path d="M8 5v14l11-7z"></path></svg>,
    PAUSE: <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className="w-6 h-6"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path></svg>,
    STOP: <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className="w-6 h-6"><path d="M6 6h12v12H6z"></path></svg>,
    RESET: <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className="w-6 h-6"><path d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"></path></svg>,
    PRINT: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v6a2 2 0 002 2h1v-4a1 1 0 011-1h8a1 1 0 011 1v4h1a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z" clipRule="evenodd" /></svg>,
    DELETE: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clipRule="evenodd" /></svg>,
    ADD_TIME: <svg xmlns="http://www.w3.org/2000/svg" className="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
    IMPORT: <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>,
    EXPORT: <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l4-4m0 0L8 8m4-4v12" /></svg>,
    SAVE_TXT: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clipRule="evenodd" /></svg>,
    EDIT: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fillRule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clipRule="evenodd" /></svg>,
    CLOSE: <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>,
};

// --- From components/ManualTimeEntryModal.tsx ---
const ManualTimeEntryModal = ({ isOpen, onClose, onAddTime, projectName }) => {
    const [hours, setHours] = useState('');
    const [minutes, setMinutes] = useState('');
    const [seconds, setSeconds] = useState('');

    useEffect(() => {
        if (isOpen) {
            setHours('');
            setMinutes('');
            setSeconds('');
        }
    }, [isOpen]);

    const handleSubmit = (e) => {
        e.preventDefault();
        const h = parseInt(hours, 10) || 0;
        const m = parseInt(minutes, 10) || 0;
        const s = parseInt(seconds, 10) || 0;
        const totalSeconds = h * 3600 + m * 60 + s;
        if (totalSeconds > 0) {
            onAddTime(totalSeconds);
        }
        onClose();
    };

    if (!isOpen) return null;

    return (
        <div 
            className="fixed inset-0 bg-black/20 backdrop-blur-md flex items-center justify-center p-4 z-50 transition-opacity duration-300"
            onClick={onClose}
            aria-modal="true"
            role="dialog"
        >
            <div 
                className="bg-white/40 backdrop-blur-xl border border-white/60 rounded-2xl shadow-xl p-6 w-full max-w-sm"
                onClick={e => e.stopPropagation()}
            >
                <h2 className="text-xl font-semibold text-slate-900 mb-2">Manually Add Time</h2>
                <p className="text-slate-700 mb-4">Adding time to project: <span className="font-bold text-cyan-700">{projectName || '...'}</span></p>

                <form onSubmit={handleSubmit} className="space-y-4">
                    <div className="flex items-center justify-center space-x-2">
                        <input 
                            type="number" 
                            min="0"
                            value={hours}
                            onChange={e => setHours(e.target.value)}
                            placeholder="HH" 
                            className="w-20 text-center bg-white/50 border-0 rounded-md px-3 py-2 text-slate-800 text-lg focus:outline-none focus:ring-2 focus:ring-cyan-500 placeholder-slate-500 transition-shadow duration-200"
                            aria-label="Hours"
                        />
                        <span className="text-2xl font-bold text-slate-600">:</span>
                        <input 
                            type="number" 
                            min="0" max="59"
                            value={minutes}
                            onChange={e => setMinutes(e.target.value)}
                            placeholder="MM" 
                            className="w-20 text-center bg-white/50 border-0 rounded-md px-3 py-2 text-slate-800 text-lg focus:outline-none focus:ring-2 focus:ring-cyan-500 placeholder-slate-500 transition-shadow duration-200"
                            aria-label="Minutes"
                        />
                        <span className="text-2xl font-bold text-slate-600">:</span>
                        <input 
                            type="number" 
                            min="0" max="59"
                            value={seconds}
                            onChange={e => setSeconds(e.target.value)}
                            placeholder="SS" 
                            className="w-20 text-center bg-white/50 border-0 rounded-md px-3 py-2 text-slate-800 text-lg focus:outline-none focus:ring-2 focus:ring-cyan-500 placeholder-slate-500 transition-shadow duration-200"
                            aria-label="Seconds"
                        />
                    </div>
                    <div className="flex justify-end space-x-3 pt-2">
                        <button type="button" onClick={onClose} className="bg-white/40 hover:bg-white/60 text-slate-800 font-bold py-2 px-4 rounded-lg transform transition-all duration-200 hover:-translate-y-px active:translate-y-px">
                            Cancel
                        </button>
                        <button type="submit" className="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-200 shadow-lg shadow-cyan-600/30 transform hover:-translate-y-px active:scale-95">
                            Add Time
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
};

// --- From components/ProjectChart.tsx ---
const ProjectChart = ({ projects, users }) => {
    const USER_COLORS = [
        'bg-sky-500', 'bg-emerald-500', 'bg-amber-500', 'bg-violet-500', 
        'bg-rose-500', 'bg-teal-500', 'bg-indigo-500', 'bg-lime-500'
    ];
    const getUserColor = (index) => USER_COLORS[index % USER_COLORS.length];
    
    const userMap = useMemo(() => new Map(users.map((u, i) => [u.id, { ...u, color: getUserColor(i) }])), [users]);
    
    const projectsWithTime = useMemo(() => projects
        .map(p => ({ ...p, totalTime: calculateTotalTime(p) }))
        .filter(p => p.totalTime > 0)
        .sort((a, b) => b.totalTime - a.totalTime), [projects]);

    if (projectsWithTime.length === 0) {
        return (
            <div className="text-center text-slate-500 p-8 mt-2 rounded-2xl shadow-[inset_6px_6px_12px_#bebebe,_inset_-6px_-6px_12px_#ffffff]">
                No time has been tracked yet. Start a timer to see the data here.
            </div>
        );
    }

    return (
        <div className="w-full space-y-3 p-3 rounded-2xl mt-2 shadow-[inset_6px_6px_12px_#bebebe,_inset_-6px_-6px_12px_#ffffff]">
            <h2 className="text-lg font-semibold text-slate-600">Time Contribution Breakdown</h2>
            
            <div className="flex flex-wrap gap-x-4 gap-y-2" aria-label="Chart Legend">
                {users.filter(u => userMap.has(u.id)).map(u => (
                    <div key={u.id} className="flex items-center space-x-2 text-sm">
                        <div className={`w-3 h-3 rounded-full ${userMap.get(u.id)?.color}`} aria-hidden="true"></div>
                        <span className="text-slate-500">{u.name}</span>
                    </div>
                ))}
            </div>

            <div className="space-y-4">
                {projectsWithTime.map(p => (
                    <div key={p.id}>
                        <div className="flex justify-between items-baseline mb-1">
                            <span className="font-medium text-slate-700" style={{ color: p.color }}>{p.name}</span>
                            <span className="text-sm font-mono text-cyan-600">{formatTime(p.totalTime)}</span>
                        </div>
                        <div className="w-full h-6 bg-[#e0e5ec] rounded-md flex overflow-hidden shadow-[inset_3px_3px_6px_#bebebe,_inset_-3px_-3px_6px_#ffffff]" role="progressbar" aria-label={`Time breakdown for ${p.name}`} aria-valuemin={0} aria-valuemax={p.totalTime} aria-valuenow={p.totalTime}>
                            {Object.entries(p.timeContributions).map(([userId, time]) => {
                                const user = userMap.get(userId);
                                if (!user || time === 0) return null;
                                const percentage = (time / p.totalTime) * 100;
                                return (
                                    <div
                                        key={userId}
                                        className={`h-full transition-all duration-300 ${user.color}`}
                                        style={{ width: `${percentage}%` }}
                                        title={`${user.name}: ${formatTime(time)}`}
                                    />
                                );
                            })}
                        </div>
                    </div>
                ))}
            </div>
        </div>
    );
};

// --- From components/ProjectManager.tsx ---
const ProjectManager = ({ projects, selectedProjectId, onAddProject, onSelectProject, onDeleteProject, onUpdateProject, availablePredefinedProjects, projectColors }) => {
    const [newProjectName, setNewProjectName] = useState('');
    const [isEditing, setIsEditing] = useState(false);
    const [editName, setEditName] = useState('');
    const [editColor, setEditColor] = useState('');

    const selectedProject = useMemo(() => projects.find(p => p.id === selectedProjectId), [projects, selectedProjectId]);

    const handleAddClick = () => {
        if (newProjectName.trim()) {
            onAddProject(newProjectName.trim());
            setNewProjectName('');
        }
    };
    
    const handleQuickAdd = (name) => {
        onAddProject(name);
        setNewProjectName('');
    };
    
    const handleStartEdit = () => {
        if (!selectedProject) return;
        setIsEditing(true);
        setEditName(selectedProject.name);
        setEditColor(selectedProject.color);
    };

    const handleCancelEdit = () => {
        setIsEditing(false);
    };

    const handleSaveEdit = () => {
        if (!selectedProjectId || !editName.trim()) return;
        onUpdateProject(selectedProjectId, editName.trim(), editColor);
        setIsEditing(false);
    };
    
    useEffect(() => {
        if (selectedProjectId === null) {
            setIsEditing(false);
        }
    }, [selectedProjectId]);

    const AddProjectUI = () => (
        <>
            <h2 className="text-lg font-semibold text-slate-600">Shared Projects</h2>
            <div className="flex space-x-2">
                <input
                    type="text"
                    value={newProjectName}
                    onChange={(e) => setNewProjectName(e.target.value)}
                    onKeyPress={(e) => e.key === 'Enter' && handleAddClick()}
                    placeholder="New project name..."
                    className="flex-grow bg-transparent rounded-lg px-3 py-2 text-slate-700 focus:outline-none placeholder-slate-400 shadow-[inset_4px_4px_8px_#bebebe,_inset_-4px_-4px_8px_#ffffff] transition-shadow duration-200 focus:ring-2 focus:ring-cyan-500/50"
                />
                <button
                    onClick={handleAddClick}
                    className="font-bold py-2 px-5 rounded-lg transition-all duration-200 text-cyan-700 bg-[#e0e5ec] shadow-[4px_4px_8px_#bebebe,_-4px_-4px_8px_#ffffff] hover:-translate-y-0.5 active:shadow-[inset_4px_4px_8px_#bebebe,_inset_-4px_-4px_8px_#ffffff]"
                >
                    Add
                </button>
            </div>
            
            {availablePredefinedProjects.length > 0 && (
                <div className="flex flex-wrap gap-2">
                    {availablePredefinedProjects.map(name => (
                        <button
                            key={name}
                            onClick={() => handleQuickAdd(name)}
                            className="bg-[#e0e5ec] shadow-[3px_3px_6px_#bebebe,_-3px_-3px_6px_#ffffff] hover:-translate-y-0.5 active:shadow-[inset_3px_3px_6px_#bebebe,_inset_-3px_-3px_6px_#ffffff] text-slate-600 text-sm font-medium py-1 px-3 rounded-full transition-all duration-200"
                            aria-label={`Quick add ${name} project`}
                        >
                            + {name}
                        </button>
                    ))}
                </div>
            )}
        </>
    );

    const EditProjectUI = () => (
        <div className="animate-pop-in">
            <h2 className="text-lg font-semibold text-slate-600">Edit Project</h2>
            <div className="space-y-3">
                <input
                    type="text"
                    value={editName}
                    onChange={(e) => setEditName(e.target.value)}
                    placeholder="Project name..."
                    className="w-full bg-transparent rounded-lg px-3 py-2 text-slate-700 focus:outline-none placeholder-slate-400 shadow-[inset_4px_4px_8px_#bebebe,_inset_-4px_-4px_8px_#ffffff] transition-shadow duration-200 focus:ring-2 focus:ring-cyan-500/50"
                />
                <div className="flex items-center justify-center space-x-2 py-1">
                    {projectColors.map(color => (
                        <button
                            key={color}
                            onClick={() => setEditColor(color)}
                            className={`w-6 h-6 rounded-full transition-all duration-200 transform focus:outline-none ${editColor === color ? 'ring-2 ring-offset-2 ring-offset-[#e0e5ec] ring-cyan-500 scale-110' : 'hover:scale-110'}`}
                            style={{ backgroundColor: color }}
                            aria-label={`Select color ${color}`}
                        />
                    ))}
                </div>
                <div className="flex justify-end space-x-2">
                     <button
                        onClick={handleCancelEdit}
                        className="font-bold py-2 px-4 rounded-lg transition-all duration-200 text-slate-600 bg-[#e0e5ec] shadow-[4px_4px_8px_#bebebe,_-4px_-4px_8px_#ffffff] hover:-translate-y-0.5 active:shadow-[inset_4px_4px_8px_#bebebe,_inset_-4px_-4px_8px_#ffffff]"
                    >
                        Cancel
                    </button>
                    <button
                        onClick={handleSaveEdit}
                        className="font-bold py-2 px-5 rounded-lg transition-all duration-200 text-white bg-cyan-600 shadow-[4px_4px_8px_#bebebe,_-4px_-4px_8px_#ffffff] hover:-translate-y-0.5 active:shadow-[inset_4px_4px_8px_#bebebe,_inset_-4px_-4px_8px_#ffffff]"
                    >
                        Save
                    </button>
                </div>
            </div>
        </div>
    );
    
    return (
        <div className="w-full space-y-3 p-3 rounded-2xl shadow-[inset_6px_6px_12px_#bebebe,_inset_-6px_-6px_12px_#ffffff]">
            {isEditing ? <EditProjectUI /> : <AddProjectUI />}

            {projects.length > 0 && (
                <div className="flex items-center space-x-2 pt-2">
                    <select
                        value={selectedProjectId || ''}
                        onChange={(e) => onSelectProject(e.target.value)}
                        disabled={isEditing}
                        className="flex-grow appearance-none bg-transparent rounded-lg px-3 py-2 text-slate-700 focus:outline-none shadow-[inset_4px_4px_8px_#bebebe,_inset_-4px_-4px_8px_#ffffff] transition-shadow duration-200 focus:ring-2 focus:ring-cyan-500/50 disabled:opacity-50"
                    >
                        <option value="" disabled>Select a project</option>
                        {projects.map(p => (
                            <option key={p.id} value={p.id}>{p.name}</option>
                        ))}
                    </select>
                     {selectedProjectId && !isEditing && (
                        <>
                            <button
                              onClick={handleStartEdit}
                              className="text-cyan-700 p-2.5 rounded-lg transition-all duration-200 bg-[#e0e5ec] shadow-[4px_4px_8px_#bebebe,_-4px_-4px_8px_#ffffff] hover:-translate-y-0.5 active:shadow-[inset_4px_4px_8px_#bebebe,_inset_-4px_-4px_8px_#ffffff]"
                              aria-label="Edit selected project"
                            >
                              {ICONS.EDIT}
                            </button>
                            <button
                              onClick={() => onDeleteProject(selectedProjectId)}
                              className="text-red-600 p-2.5 rounded-lg transition-all duration-200 bg-[#e0e5ec] shadow-[4px_4px_8px_#bebebe,_-4px_-4px_8px_#ffffff] hover:-translate-y-0.5 active:shadow-[inset_4px_4px_8px_#bebebe,_inset_-4px_-4px_8px_#ffffff]"
                              aria-label="Delete selected project"
                            >
                              {ICONS.DELETE}
                            </button>
                        </>
                      )}
                </div>
            )}
        </div>
    );
};


// --- From components/PrintableReport.tsx ---
const PrintableReport = ({ projects, users }) => {
    const userMap = useMemo(() => new Map(users.map(u => [u.id, u.name])), [users]);
    const totalTrackedTime = useMemo(() => projects.reduce((total, p) => total + calculateTotalTime(p), 0), [projects]);
    const projectsWithTime = useMemo(() => projects
        .map(p => ({ ...p, totalTime: calculateTotalTime(p) }))
        .filter(p => p.totalTime > 0)
        .sort((a, b) => b.totalTime - a.totalTime), [projects]);

    return (
        <div style={{ fontFamily: 'sans-serif', color: '#111827' }}>
            <h1 style={{ fontSize: '24pt', marginBottom: '0.5rem', color: '#1f2937' }}>Project Time Report</h1>
            <p style={{ fontSize: '11pt', color: '#6b7280', marginTop: 0 }}>Generated on: {new Date().toLocaleString()}</p>
            
            <div style={{ marginTop: '2rem' }}>
                <h2 style={{ fontSize: '18pt', marginTop: '1.5rem', borderBottom: '2px solid #e5e7eb', paddingBottom: '0.5rem', marginBottom: '1rem', color: '#111827' }}>Summary</h2>
                <p style={{ fontSize: '14pt' }}>
                    <strong>Total Time Tracked:</strong> {formatTime(totalTrackedTime)}
                </p>
            </div>
            
            <div style={{ marginTop: '2rem' }}>
                 <h2 style={{ fontSize: '18pt', marginTop: '1.5rem', borderBottom: '2px solid #e5e7eb', paddingBottom: '0.5rem', marginBottom: '1rem', color: '#111827' }}>Project Breakdown</h2>
                 {projectsWithTime.length > 0 ? projectsWithTime.map(p => (
                    <div key={p.id} style={{ pageBreakInside: 'avoid', marginTop: '1.5rem', border: '1px solid #f3f4f6', padding: '1rem', borderRadius: '8px' }}>
                        <h3 style={{ fontSize: '16pt', margin: '0 0 0.5rem 0', color: p.color }}>{p.name}</h3>
                        <p style={{ fontSize: '12pt', margin: '0 0 1rem 0', color: '#4b5563' }}>
                            <strong>Total Project Time:</strong> {formatTime(p.totalTime)}
                        </p>
                        <table style={{width: '100%', borderCollapse: 'collapse'}}>
                            <thead>
                                <tr>
                                    <th style={{textAlign: 'left', padding: '0.5rem', borderBottom: '1px solid #e5e7eb'}}>User</th>
                                    <th style={{textAlign: 'right', padding: '0.5rem', borderBottom: '1px solid #e5e7eb'}}>Time Contributed</th>
                                </tr>
                            </thead>
                            <tbody>
                            {Object.entries(p.timeContributions).filter(([, time]) => time > 0).sort(([,a], [,b]) => b - a).map(([userId, time]) => (
                                <tr key={userId}>
                                    <td style={{ padding: '0.5rem', borderTop: '1px solid #f9fafb' }}>{userMap.get(userId) || 'Unassigned User'}</td>
                                    <td style={{ padding: '0.5rem', textAlign: 'right', fontFamily: 'monospace' }}>{formatTime(time)}</td>
                                </tr>
                            ))}
                            </tbody>
                        </table>
                    </div>
                )) : <p>No time has been tracked yet.</p>}
            </div>
        </div>
    );
};

// --- From components/TimerControls.tsx ---
const TimerControls = ({ status, onStartPause, onReset, onAddTimeClick, isProjectSelected }) => {
    const baseButtonClasses = "p-4 rounded-full text-slate-600 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-[#e0e5ec] focus:ring-cyan-500 disabled:opacity-50 disabled:cursor-not-allowed shadow-[5px_5px_10px_#bebebe,_-5px_-5px_10px_#ffffff] hover:-translate-y-0.5 active:shadow-[inset_5px_5px_10px_#bebebe,_inset_-5px_-5px_10px_#ffffff]";
    const primaryButtonClasses = "px-8 py-3 font-semibold flex items-center space-x-2";

    const startPauseStyles = status === TimerStatus.Running
        ? 'bg-yellow-400/50 text-yellow-800'
        : 'bg-green-400/50 text-green-800';

    return (
        <div className="flex justify-center items-center space-x-4 my-2">
            <button
                onClick={onAddTimeClick}
                disabled={!isProjectSelected}
                className={`${baseButtonClasses} bg-[#e0e5ec]`}
                aria-label="Manually Add Time"
            >
                {ICONS.ADD_TIME}
            </button>
            <button
                key={status}
                onClick={onStartPause}
                disabled={!isProjectSelected}
                className={`${baseButtonClasses} ${primaryButtonClasses} ${startPauseStyles} animate-pop-in`}
            >
                {status === TimerStatus.Running ? ICONS.PAUSE : ICONS.PLAY}
                <span>{status === TimerStatus.Running ? 'Pause' : 'Start'}</span>
            </button>
            <button
                onClick={onReset}
                disabled={!isProjectSelected}
                className={`${baseButtonClasses} bg-red-500/50 text-red-800`}
                aria-label="Reset Project Timer"
            >
                {ICONS.RESET}
            </button>
        </div>
    );
};

// --- From components/TimerDisplay.tsx ---
const TimerDisplay = ({ project, totalTime, color, status }) => {
    const timerTextClasses = {
        [TimerStatus.Stopped]: 'text-cyan-600 scale-100',
        [TimerStatus.Running]: 'text-green-600 scale-105',
        [TimerStatus.Paused]: 'text-yellow-700 scale-100',
    };

    const containerClasses = [
        "text-center my-1 p-2 rounded-3xl",
        "shadow-[inset_8px_8px_16px_#bebebe,_inset_-8px_-8px_16px_#ffffff]",
        "border-2",
        "border-transparent",
        "transition-all duration-300"
    ];
    
    const containerStyle = {};

    if (status === TimerStatus.Running && color !== 'transparent') {
        containerClasses.push('animate-pulse-border');
        containerStyle['--pulse-color'] = color;
    }

    return (
        <div className={containerClasses.join(' ')} style={containerStyle}>
            <h3 
                className="text-xl font-light text-slate-600 mb-2 transition-colors duration-300" 
                style={{ color: color !== 'transparent' ? color : undefined }}
            >
                {project?.name || 'No Project Selected'}
            </h3>
            <p className={`text-5xl font-mono font-bold tracking-wider transition-all duration-300 transform ${timerTextClasses[status]}`}>
                {formatTime(totalTime)}
            </p>
        </div>
    );
}

// --- From components/Toast.tsx ---
const Toast = ({ toast }) => {
    if (!toast) return null;

    const baseClasses = "fixed bottom-5 left-1/2 -translate-x-1/2 px-6 py-3 rounded-xl font-semibold transition-all duration-300 shadow-[5px_5px_10px_#bebebe,_-5px_-5px_10px_#ffffff] bg-[#e0e5ec]";
    const typeClasses = {
        success: "text-green-700",
        error: "text-red-700",
    };

    return (
        <div className={`${baseClasses} ${typeClasses[toast.type]} ${toast ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-4'}`} role="alert">
            {toast.message}
        </div>
    );
};

// --- From components/UserManager.tsx ---
const UserManager = ({ users, selectedUserId, onAddUser, onSelectUser, onDeleteUser }) => {
    const [newUserName, setNewUserName] = useState('');

    const handleAddClick = () => {
        if (newUserName.trim()) {
            onAddUser(newUserName.trim());
            setNewUserName('');
        }
    };

    return (
        <div className="w-full space-y-3 p-3 rounded-2xl mb-2 shadow-[inset_6px_6px_12px_#bebebe,_inset_-6px_-6px_12px_#ffffff]">
            <h2 className="text-lg font-semibold text-slate-600">Users</h2>
            <div className="flex space-x-2">
                <input
                    type="text"
                    value={newUserName}
                    onChange={(e) => setNewUserName(e.target.value)}
                    onKeyPress={(e) => e.key === 'Enter' && handleAddClick()}
                    placeholder="New user name..."
                    className="flex-grow bg-transparent rounded-lg px-3 py-2 text-slate-700 focus:outline-none placeholder-slate-400 shadow-[inset_4px_4px_8px_#bebebe,_inset_-4px_-4px_8px_#ffffff] transition-shadow duration-200 focus:ring-2 focus:ring-cyan-500/50"
                />
                <button
                    onClick={handleAddClick}
                    className="font-bold py-2 px-5 rounded-lg transition-all duration-200 text-cyan-700 bg-[#e0e5ec] shadow-[4px_4px_8px_#bebebe,_-4px_-4px_8px_#ffffff] hover:-translate-y-0.5 active:shadow-[inset_4px_4px_8px_#bebebe,_inset_-4px_-4px_8px_#ffffff]"
                >
                    Add User
                </button>
            </div>
            {users.length > 0 && (
                <div className="flex items-center space-x-2">
                    <select
                        value={selectedUserId || ''}
                        onChange={(e) => onSelectUser(e.target.value)}
                        className="flex-grow appearance-none bg-transparent rounded-lg px-3 py-2 text-slate-700 focus:outline-none shadow-[inset_4px_4px_8px_#bebebe,_inset_-4px_-4px_8px_#ffffff] transition-shadow duration-200 focus:ring-2 focus:ring-cyan-500/50"
                    >
                        <option value="" disabled>Select a user</option>
                        {users.map(u => (
                            <option key={u.id} value={u.id}>{u.name}</option>
                        ))}
                    </select>
                     {selectedUserId && (
                        <button
                          onClick={() => onDeleteUser(selectedUserId)}
                          className="text-red-600 p-2.5 rounded-lg transition-all duration-200 bg-[#e0e5ec] shadow-[4px_4px_8px_#bebebe,_-4px_-4px_8px_#ffffff] hover:-translate-y-0.5 active:shadow-[inset_4px_4px_8px_#bebebe,_inset_-4px_-4px_8px_#ffffff]"
                          aria-label="Delete selected user"
                        >
                          {ICONS.DELETE}
                        </button>
                      )}
                </div>
            )}
        </div>
    );
}

// --- From components/PopOutTimer.tsx ---
const PopOutTimer = ({
    project,
    totalTime,
    color,
    onClose,
    opacity,
    onOpacityChange,
    status,
    position,
    onPositionChange,
    onStartPause,
    onStop,
}) => {
    const statusText = status === TimerStatus.Running ? 'Running' : 'Paused';
    const statusColor = status === TimerStatus.Running ? 'text-green-600' : 'text-yellow-600';
    
    const dragRef = useRef(null);
    const dragStartOffset = useRef({ x: 0, y: 0 });

    const handleMouseDown = (e) => {
        if (e.target !== e.currentTarget && e.target.closest('button')) {
            return;
        }
        if (!dragRef.current) return;
        
        e.preventDefault();

        const rect = dragRef.current.getBoundingClientRect();
        dragStartOffset.current = {
            x: e.clientX - rect.left,
            y: e.clientY - rect.top,
        };

        window.addEventListener('mousemove', handleMouseMove);
        window.addEventListener('mouseup', handleMouseUp, { once: true });
    };

    const handleMouseMove = (e) => {
        if (!dragRef.current) return;

        const { innerWidth, innerHeight } = window;
        const { width, height } = dragRef.current.getBoundingClientRect();

        let newX = e.clientX - dragStartOffset.current.x;
        let newY = e.clientY - dragStartOffset.current.y;
        
        newX = Math.max(0, Math.min(newX, innerWidth - width));
        newY = Math.max(0, Math.min(newY, innerHeight - height));

        onPositionChange({
            x: newX,
            y: newY,
        });
    };

    const handleMouseUp = () => {
        window.removeEventListener('mousemove', handleMouseMove);
    };

    const startPauseStyles = status === TimerStatus.Running
        ? 'bg-yellow-500 hover:bg-yellow-600'
        : 'bg-green-500 hover:bg-green-600';

    return (
        <div
            ref={dragRef}
            className="w-[288px] rounded-2xl shadow-2xl overflow-hidden bg-white/40 backdrop-blur-xl text-slate-800 select-none flex flex-col border border-white/60"
            style={{ 
                position: 'fixed', 
                top: `${position.y}px`, 
                left: `${position.x}px`, 
                opacity,
                zIndex: 2147483647
            }}
        >
            <header
                className="flex items-center justify-between p-3 flex-shrink-0 cursor-move bg-black/10"
                onMouseDown={handleMouseDown}
            >
                <div className="flex items-center space-x-2 overflow-hidden">
                    <div className="w-3 h-3 rounded-full flex-shrink-0" style={{ backgroundColor: color }}></div>
                    <h2 className="font-bold text-slate-900 truncate" style={{textShadow: '0 1px 1px rgba(255,255,255,0.5)'}} title={project.name}>{project.name}</h2>
                </div>
                <button
                    onClick={onClose}
                    className="text-slate-700 hover:text-slate-900 transition-all transform hover:rotate-90 active:scale-90 flex-shrink-0 ml-2 z-10"
                    aria-label="Close timer window"
                >
                    {ICONS.CLOSE}
                </button>
            </header>
            <main className="text-center p-4 flex-grow flex flex-col justify-center">
                <div>
                    <p className={`text-sm font-semibold mb-1 ${statusColor}`} style={{textShadow: '0 1px 1px rgba(255,255,255,0.5)'}}>{statusText}</p>
                    <p className="text-5xl font-mono font-bold text-cyan-700 tracking-wider" style={{textShadow: '0 1px 2px rgba(255,255,255,0.4)'}}>
                        {formatTime(totalTime)}
                    </p>
                </div>
                <div className="flex justify-center items-center space-x-4 mt-4">
                    <button
                        onClick={onStartPause}
                        className={`p-3 rounded-full text-white transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-white/80 ${startPauseStyles} transform hover:-translate-y-0.5 active:translate-y-px`}
                        aria-label={status === TimerStatus.Running ? 'Pause timer' : 'Start timer'}
                        style={{boxShadow: '2px 2px 5px rgba(0,0,0,0.2), -2px -2px 5px rgba(255,255,255,0.7)', textShadow: '1px 1px 2px rgba(0,0,0,0.3)'}}
                    >
                        {status === TimerStatus.Running ? ICONS.PAUSE : ICONS.PLAY}
                    </button>
                    <button
                        onClick={onStop}
                        className="p-3 rounded-full bg-red-600 hover:bg-red-700 text-white transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-white/80 transform hover:-translate-y-0.5 active:translate-y-px"
                        aria-label="Stop timer"
                        style={{boxShadow: '2px 2px 5px rgba(0,0,0,0.2), -2px -2px 5px rgba(255,255,255,0.7)', textShadow: '1px 1px 2px rgba(0,0,0,0.3)'}}
                    >
                        {ICONS.STOP}
                    </button>
                </div>
            </main>
            <footer className="p-3 bg-black/10 flex-shrink-0">
                 <label htmlFor="opacity-slider" className="text-xs text-slate-600 mb-1 block" style={{textShadow: '0 1px 1px rgba(255,255,255,0.5)'}}>Adjust Opacity</label>
                 <input
                    id="opacity-slider"
                    type="range"
                    min="0.2"
                    max="1"
                    step="0.05"
                    value={opacity}
                    onChange={(e) => onOpacityChange(parseFloat(e.target.value))}
                    className="w-full h-2 bg-white/40 rounded-lg appearance-none cursor-pointer accent-cyan-600"
                />
            </footer>
        </div>
    );
};

// --- From components/PomodoroSettings.tsx ---
const PomodoroSettings = ({ isEnabled, onToggle, sessionTime }) => {
    const POMODORO_DURATION = 25 * 60;
    const progress = (sessionTime % POMODORO_DURATION) / POMODORO_DURATION * 100;
    
    const remainingSeconds = POMODORO_DURATION - (sessionTime % POMODORO_DURATION);
    const remainingMinutes = Math.ceil(remainingSeconds / 60);

    const countdownText = (sessionTime > 0 && sessionTime % POMODORO_DURATION === 0) 
        ? 'Time for a break!' 
        : `Next break in ${remainingMinutes} min`;

    return (
        <div className="my-1 p-2 rounded-2xl space-y-1 shadow-[inset_6px_6px_12px_#bebebe,_inset_-6px_-6px_12px_#ffffff]">
            <div className="flex items-center justify-between">
                <label htmlFor="pomodoro-toggle" className="text-slate-600 font-medium cursor-pointer">
                    Pomodoro Notifications
                    <p className="text-xs text-slate-500">Get a notification every 25 minutes.</p>
                </label>
                <button
                    id="pomodoro-toggle"
                    role="switch"
                    aria-checked={isEnabled}
                    onClick={() => onToggle(!isEnabled)}
                    className={`relative group inline-flex items-center h-6 rounded-full w-11 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-[#e0e5ec] focus:ring-cyan-500 shadow-[inset_2px_2px_4px_#bebebe,_inset_-2px_-2px_4px_#ffffff] ${
                        isEnabled ? 'bg-cyan-600/50' : 'bg-slate-400/20'
                    }`}
                >
                    <span
                        className={`inline-block w-4 h-4 transform bg-white rounded-full transition-transform duration-200 shadow-md group-hover:scale-110 group-active:scale-95 ${
                            isEnabled ? 'translate-x-6' : 'translate-x-1'
                        }`}
                        aria-hidden="true"
                    />
                </button>
            </div>
            {isEnabled && (
                 <div>
                    <div className="w-full h-2 bg-[#e0e5ec] rounded-full overflow-hidden mt-2 shadow-[inset_2px_2px_4px_#bebebe,_inset_-2px_-2px_4px_#ffffff]" aria-label="Pomodoro progress">
                        <div
                            className="h-full bg-cyan-500 rounded-full transition-all duration-1000 ease-linear"
                            style={{ width: `${progress}%` }}
                            role="progressbar"
                            aria-valuenow={progress}
                            aria-valuemin={0}
                            aria-valuemax={100}
                        ></div>
                    </div>
                     <p className="text-xs text-slate-500 text-right mt-1">
                        {countdownText}
                    </p>
                </div>
            )}
        </div>
    );
};

// --- From App.tsx ---
function App() {
    // --- CONSTANTS ---
    const PROJECT_COLORS = [
        '#f87171', '#60a5fa', '#4ade80', '#facc15',
        '#c084fc', '#f472b6', '#818cf8', '#fb923c',
    ];
    const ACTIVE_COLOR_MAP = {
        '#f87171': '#fb7185', '#60a5fa': '#93c5fd', '#4ade80': '#86efac', '#facc15': '#fde047',
        '#c084fc': '#d8b4fe', '#f472b6': '#f9a8d4', '#818cf8': '#a5b4fc', '#fb923c': '#fcd34d',
    };
    const PREDEFINED_PROJECT_NAMES = ["Data", "Design", "Code", "Compile", "Redesign"];
    const INITIAL_USERS = [
        { id: 'user-tk', name: 'T.K.' }, { id: 'user-karl', name: 'Karl' }, { id: 'user-Wyatt', name: 'Wyatt' },
    ];
    const POMODORO_DURATION = 25 * 60;

    // --- STATE MANAGEMENT ---
    const [projects, setProjects] = useLocalStorage('projects', []);
    const [selectedProjectId, setSelectedProjectId] = useLocalStorage('selectedProjectId', null);
    const [users, setUsers] = useLocalStorage('users', INITIAL_USERS);
    const [selectedUserId, setSelectedUserId] = useLocalStorage('selectedUserId', null);
    const [popOutPosition, setPopOutPosition] = useLocalStorage('popOutPosition', { x: window.innerWidth - 308, y: 50 });
    const [popOutOpacity, setPopOutOpacity] = useLocalStorage('popOutOpacity', 0.85);
    const [status, setStatus] = useState(TimerStatus.Stopped);
    const [isAddTimeModalOpen, setAddTimeModalOpen] = useState(false);
    const [toast, setToast] = useState(null);
    const importFileRef = useRef(null);
    
    const [sessionTime, setSessionTime] = useState(0);
    const [isPomodoroEnabled, setPomodoroEnabled] = useLocalStorage('pomodoroEnabled', true);
    const [isPopOutVisible, setPopOutVisible] = useState(false);
    const [isMainAppVisible, setMainAppVisible] = useState(true);
    const statusRef = useRef(status);
    useEffect(() => { statusRef.current = status; }, [status]);

    // --- EFFECTS ---
    useEffect(() => {
        const checkAndCorrectPosition = () => {
            const timerWidth = 288, timerHeight = 280, margin = 40;
            const { innerWidth, innerHeight } = window;
            setPopOutPosition(currentPosition => {
                const isOffScreen = currentPosition.x > innerWidth - margin || currentPosition.x < -timerWidth + margin || currentPosition.y > innerHeight - margin || currentPosition.y < -timerHeight + margin;
                return isOffScreen ? { x: innerWidth - timerWidth - 20, y: 50 } : currentPosition;
            });
        };
        checkAndCorrectPosition();
        window.addEventListener('resize', checkAndCorrectPosition);
        return () => window.removeEventListener('resize', checkAndCorrectPosition);
    }, [setPopOutPosition]);

    const selectedUser = useMemo(() => users.find(u => u.id === selectedUserId), [users, selectedUserId]);
    const selectedProject = useMemo(() => projects.find(p => p.id === selectedProjectId) || null, [projects, selectedProjectId]);
    const selectedProjectColor = useMemo(() => {
        if (!selectedProject) return 'transparent';
        return status === TimerStatus.Running ? (ACTIVE_COLOR_MAP[selectedProject.color] || selectedProject.color) : selectedProject.color;
    }, [selectedProject, status]);
    const selectedProjectTotalTime = useMemo(() => selectedProject ? calculateTotalTime(selectedProject) : 0, [selectedProject]);
    const existingProjectNames = useMemo(() => new Set(projects.map(p => p.name)), [projects]);
    const availablePredefinedProjects = PREDEFINED_PROJECT_NAMES.filter(name => !existingProjectNames.has(name));

    const showToast = useCallback((message, type = 'success') => {
        setToast({ message, type });
        setTimeout(() => setToast(null), 3000);
    }, []);

    const showPomodoroNotification = useCallback((projectName) => {
        if (Notification.permission === 'granted') {
            new Notification('Pomodoro Complete!', {
                body: `25 minutes on "${projectName}" is up. Time for a break!`,
                icon: '/vite.svg',
                silent: false,
            });
        }
    }, []);

    const handlePopOutClose = useCallback(() => {
        setPopOutVisible(false);
        if (statusRef.current === TimerStatus.Running) setStatus(TimerStatus.Paused);
    }, []);

    useEffect(() => {
        if (isPomodoroEnabled && Notification.permission === 'default') {
            Notification.requestPermission().then(permission => {
                if (permission !== 'granted') {
                    showToast('Notifications disabled. You can enable them in browser settings.', 'error');
                    setPomodoroEnabled(false);
                }
            });
        }
    }, [isPomodoroEnabled, showToast, setPomodoroEnabled]);

    useEffect(() => {
        setProjects(prevProjects => {
            const needsUpdate = prevProjects.some(p => !p.color);
            if (!needsUpdate) return prevProjects;
            return prevProjects.map((p, i) => p.color ? p : { ...p, color: PROJECT_COLORS[i % PROJECT_COLORS.length] });
        });
    }, [setProjects]);

    useEffect(() => { if (status === TimerStatus.Stopped) setSessionTime(0); }, [status]);
    useEffect(() => { if (status !== TimerStatus.Running) setMainAppVisible(true); }, [status]);

    useEffect(() => {
        let interval;
        if (status === TimerStatus.Running && selectedProjectId && selectedUserId) {
            interval = window.setInterval(() => {
                setProjects(prevProjects =>
                    prevProjects.map(p => {
                        if (p.id === selectedProjectId) {
                            const newContributions = { ...(p.timeContributions || {}) };
                            newContributions[selectedUserId] = (newContributions[selectedUserId] || 0) + 1;
                            return { ...p, timeContributions: newContributions };
                        }
                        return p;
                    })
                );
                setSessionTime(prev => {
                    const newSessionTime = prev + 1;
                    if (isPomodoroEnabled && newSessionTime > 0 && newSessionTime % POMODORO_DURATION === 0) {
                        showPomodoroNotification(selectedProject?.name || 'your project');
                    }
                    return newSessionTime;
                });
            }, 1000);
        }
        return () => { if (interval) clearInterval(interval); };
    }, [status, selectedProjectId, selectedUserId, setProjects, isPomodoroEnabled, selectedProject, showPomodoroNotification]);

    const handleAddUser = useCallback((name) => {
        const newUser = { id: Date.now().toString(), name };
        setUsers(prev => [...prev, newUser]);
        setSelectedUserId(newUser.id);
        showToast(`User '${name}' added`);
    }, [setUsers, setSelectedUserId, showToast]);
    const handleSelectUser = useCallback((id) => { setSelectedUserId(id); setStatus(TimerStatus.Stopped); handlePopOutClose(); }, [setSelectedUserId, handlePopOutClose]);
    const handleDeleteUser = useCallback((id) => {
        if (window.confirm("Are you sure you want to delete this user? Their tracked time will remain but will be unassigned.")) {
            const userToDelete = users.find(u => u.id === id);
            const newUsers = users.filter(u => u.id !== id);
            setUsers(newUsers);
            if (selectedUserId === id) setSelectedUserId(newUsers.length > 0 ? newUsers[0].id : null);
            setStatus(TimerStatus.Stopped);
            handlePopOutClose();
            showToast(`User '${userToDelete?.name}' deleted`, 'error');
        }
    }, [users, selectedUserId, setUsers, setSelectedUserId, showToast, handlePopOutClose]);

    const handleAddProject = useCallback((name) => {
        const newProjectId = Date.now().toString();
        setProjects(prev => [...prev, { id: newProjectId, name, timeContributions: {}, color: PROJECT_COLORS[prev.length % PROJECT_COLORS.length] }]);
        setSelectedProjectId(newProjectId);
        setStatus(TimerStatus.Stopped);
        showToast(`Project '${name}' created`);
    }, [setProjects, setSelectedProjectId, showToast]);
    const handleSelectProject = useCallback((id) => { setSelectedProjectId(id); setStatus(TimerStatus.Stopped); handlePopOutClose(); }, [setSelectedProjectId, handlePopOutClose]);
    const handleDeleteProject = useCallback((id) => {
       if (window.confirm("Are you sure you want to delete this project and all its tracked time? This will affect all users.")) {
           const projectToDelete = projects.find(p => p.id === id);
           const remainingProjects = projects.filter(p => p.id !== id);
           setProjects(remainingProjects);
           if(selectedProjectId === id) setSelectedProjectId(remainingProjects.length > 0 ? remainingProjects[0].id : null);
           setStatus(TimerStatus.Stopped);
           handlePopOutClose();
           showToast(`Project '${projectToDelete?.name}' deleted`, 'error');
       }
    }, [projects, selectedProjectId, setProjects, setSelectedProjectId, showToast, handlePopOutClose]);
    const handleUpdateProject = useCallback((id, newName, newColor) => {
        setProjects(prev => prev.map(p => 
            p.id === id ? { ...p, name: newName, color: newColor } : p
        ));
        showToast(`Project '${newName}' updated successfully`);
    }, [setProjects, showToast]);

    const handleStartPause = useCallback(() => {
        if (!selectedProjectId) return;
        const newStatus = status === TimerStatus.Running ? TimerStatus.Paused : TimerStatus.Running;
        setStatus(newStatus);
        if (newStatus === TimerStatus.Running) { setPopOutVisible(true); setMainAppVisible(false); }
    }, [selectedProjectId, status]);
    const handleStop = useCallback(() => { setStatus(TimerStatus.Stopped); setPopOutVisible(false); }, []);
    const handleReset = useCallback(() => {
        if (window.confirm("Are you sure you want to reset the time for this project? This will affect all users.")) {
            setProjects(prevProjects => prevProjects.map(p => p.id === selectedProjectId ? { ...p, timeContributions: {} } : p));
            setStatus(TimerStatus.Stopped);
            handlePopOutClose();
            showToast(`Timer for '${selectedProject?.name}' reset`);
        }
    }, [selectedProjectId, setProjects, selectedProject?.name, showToast, handlePopOutClose]);
    const handleAddTime = useCallback((secondsToAdd) => {
        if (!selectedProjectId || !selectedUserId || secondsToAdd <= 0) return;
        setProjects(prevProjects => prevProjects.map(p => {
            if (p.id === selectedProjectId) {
                const newContributions = { ...p.timeContributions };
                newContributions[selectedUserId] = (newContributions[selectedUserId] || 0) + secondsToAdd;
                return { ...p, timeContributions: newContributions };
            }
            return p;
        }));
        showToast(`Added ${formatTime(secondsToAdd)} to '${selectedProject?.name}'`);
    }, [selectedProjectId, selectedUserId, setProjects, showToast, selectedProject?.name]);

    const handleExportData = useCallback(() => {
        const dataStr = JSON.stringify({ projects, users }, null, 2);
        const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
        const exportFileDefaultName = `time-tracker-backup-${new Date().toISOString().slice(0,10)}.json`;
        const linkElement = document.createElement('a');
        linkElement.setAttribute('href', dataUri);
        linkElement.setAttribute('download', exportFileDefaultName);
        linkElement.click();
        showToast('Data exported successfully!');
    }, [projects, users, showToast]);
    const handleImportData = useCallback((event) => {
        const file = event.target.files?.[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const text = e.target?.result;
                if (typeof text !== 'string') throw new Error("File is not readable");
                const data = JSON.parse(text);
                if (!Array.isArray(data.projects) || !Array.isArray(data.users)) throw new Error("Invalid file format");
                if (window.confirm("Are you sure you want to import this data? This will overwrite all current projects and users.")) {
                    setProjects(data.projects);
                    setUsers(data.users);
                    setSelectedProjectId(data.projects.length > 0 ? data.projects[0].id : null);
                    setSelectedUserId(data.users.length > 0 ? data.users[0].id : null);
                    showToast('Data imported successfully!');
                }
            } catch (error) { showToast(error instanceof Error ? error.message : "An unknown error occurred", "error"); }
            finally { if(event.target) event.target.value = ''; }
        };
        reader.readAsText(file);
    }, [setProjects, setUsers, setSelectedProjectId, setSelectedUserId, showToast]);

    const handleSaveAsTxt = useCallback(() => {
        const userMap = new Map(users.map(u => [u.id, u.name]));
        const totalTrackedTime = projects.reduce((total, p) => total + calculateTotalTime(p), 0);
        const projectsWithTime = projects.map(p => ({ ...p, totalTime: calculateTotalTime(p) })).filter(p => p.totalTime > 0).sort((a, b) => b.totalTime - a.totalTime);
        let content = `Project Time Report\nGenerated on: ${new Date().toLocaleString()}\n\n========================================\nSUMMARY\n========================================\nTotal Time Tracked: ${formatTime(totalTrackedTime)}\n\n========================================\nPROJECT BREAKDOWN\n========================================\n\n`;
        if (projectsWithTime.length > 0) {
            projectsWithTime.forEach(p => {
                content += `Project: ${p.name}\nTotal Project Time: ${formatTime(p.totalTime)}\n----------------------------------------\nUser Contributions:\n`;
                const contributions = Object.entries(p.timeContributions).filter(([, time]) => time > 0).sort(([,a], [,b]) => b - a);
                if (contributions.length > 0) contributions.forEach(([userId, time]) => { content += `- ${userMap.get(userId) || 'Unassigned User'}: ${formatTime(time)}\n`; });
                else content += `- No contributions yet.\n`;
                content += `\n`;
            });
        } else content += `No time has been tracked yet.\n`;
        const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const exportFileDefaultName = `time-tracker-report-${new Date().toISOString().slice(0,10)}.txt`;
        const linkElement = document.createElement('a');
        linkElement.setAttribute('href', url);
        linkElement.setAttribute('download', exportFileDefaultName);
        document.body.appendChild(linkElement);
        linkElement.click();
        document.body.removeChild(linkElement);
        URL.revokeObjectURL(url);
        showToast('Report saved as .txt file!');
    }, [projects, users, showToast]);
    
    const handlePrint = useCallback(() => {
        const printContainer = document.createElement('div');
        printContainer.id = 'print-container';
        document.body.appendChild(printContainer);
        const printStyles = `body { margin: 1cm; } @media print { #print-container { display: block; } } @page { size: auto; margin: 20mm; }`;
        const styleSheet = document.createElement('style');
        styleSheet.type = 'text/css';
        styleSheet.innerText = printStyles;
        document.head.appendChild(styleSheet);
        const printRoot = ReactDOM.createRoot(printContainer);
        printRoot.render(<StrictMode><PrintableReport projects={projects} users={users} /></StrictMode>);
        setTimeout(() => {
            window.print();
            printRoot.unmount();
            document.body.removeChild(printContainer);
            document.head.removeChild(styleSheet);
        }, 250);
    }, [projects, users]);

    return (
        <>
            {isMainAppVisible && (
                <div className="min-h-screen flex items-center justify-center font-sans p-4">
                    <div 
                        className="w-full max-w-md mx-auto bg-[#e0e5ec] rounded-3xl shadow-[8px_8px_16px_#bebebe,_-8px_-8px_16px_#ffffff] text-slate-700 p-3 space-y-2 overflow-y-auto"
                        style={{maxHeight: '95vh'}}
                    >
                        <header className="text-center">
                            <h1 className="text-3xl font-bold text-slate-800">Project Time Tracker</h1>
                            <p className="text-slate-500">{selectedUser ? `Tracking as ${selectedUser.name}` : 'Select or create a user to begin.'}</p>
                        </header>
                        <main>
                            <UserManager users={users} selectedUserId={selectedUserId} onAddUser={handleAddUser} onSelectUser={handleSelectUser} onDeleteUser={handleDeleteUser} />
                            {selectedUserId ? (
                                <>
                                    <ProjectManager 
                                        projects={projects} 
                                        selectedProjectId={selectedProjectId} 
                                        availablePredefinedProjects={availablePredefinedProjects} 
                                        onAddProject={handleAddProject} 
                                        onSelectProject={handleSelectProject} 
                                        onDeleteProject={handleDeleteProject}
                                        onUpdateProject={handleUpdateProject}
                                        projectColors={PROJECT_COLORS}
                                    />
                                    <TimerDisplay project={selectedProject} totalTime={selectedProjectTotalTime} color={selectedProjectColor} status={status} />
                                    <TimerControls status={status} onStartPause={handleStartPause} onReset={handleReset} onAddTimeClick={() => setAddTimeModalOpen(true)} isProjectSelected={!!selectedProjectId} />
                                    {selectedProjectId && <PomodoroSettings isEnabled={isPomodoroEnabled} onToggle={setPomodoroEnabled} sessionTime={sessionTime} />}
                                    <ProjectChart projects={projects} users={users} />
                                    {projects.length > 0 && (
                                        <div className="mt-2 grid grid-cols-2 gap-4">
                                            <button onClick={handlePrint} className="font-bold py-3 px-4 rounded-xl transition-all duration-200 flex items-center justify-center space-x-2 text-indigo-600 bg-[#e0e5ec] shadow-[5px_5px_10px_#bebebe,_-5px_-5px_10px_#ffffff] hover:-translate-y-0.5 active:shadow-[inset_5px_5px_10px_#bebebe,_inset_-5px_-5px_10px_#ffffff]" aria-label="Save and Print Project Report">{ICONS.PRINT}<span>Print</span></button>
                                            <button onClick={handleSaveAsTxt} className="font-bold py-3 px-4 rounded-xl transition-all duration-200 flex items-center justify-center space-x-2 text-sky-600 bg-[#e0e5ec] shadow-[5px_5px_10px_#bebebe,_-5px_-5px_10px_#ffffff] hover:-translate-y-0.5 active:shadow-[inset_5px_5px_10px_#bebebe,_inset_-5px_-5px_10px_#ffffff]" aria-label="Save report as a text file">{ICONS.SAVE_TXT}<span>Save .txt</span></button>
                                        </div>
                                    )}
                                </>
                            ) : (
                                <div className="text-center text-slate-500 p-8 rounded-2xl shadow-[inset_6px_6px_12px_#bebebe,_inset_-6px_-6px_12px_#ffffff]">
                                    Please select a user to start tracking time.
                                </div>
                            )}
                        </main>
                        <footer className="text-center text-slate-500 text-xs pt-4 border-t border-slate-300/70">
                            <div className="flex justify-center items-center space-x-4">
                                <input type="file" ref={importFileRef} onChange={handleImportData} accept=".json" style={{ display: 'none' }} />
                                <button onClick={() => importFileRef.current?.click()} className="flex items-center space-x-1 hover:text-cyan-600 transition-all transform hover:-translate-y-px">{ICONS.IMPORT}<span>Import Data</span></button>
                                <button onClick={handleExportData} className="flex items-center space-x-1 hover:text-cyan-600 transition-all transform hover:-translate-y-px">{ICONS.EXPORT}<span>Export Data</span></button>
                            </div>
                            <p className="mt-4">Copyright &copy; 2025 Karl J. Fox. All Rights Reserved.</p>
                        </footer>
                    </div>
                </div>
            )}
            <ManualTimeEntryModal isOpen={isAddTimeModalOpen} onClose={() => setAddTimeModalOpen(false)} onAddTime={handleAddTime} projectName={selectedProject?.name} />
            <Toast toast={toast} />
            {isPopOutVisible && selectedProject && (
                <PopOutTimer project={selectedProject} totalTime={selectedProjectTotalTime} color={selectedProjectColor} onClose={handlePopOutClose} opacity={popOutOpacity} onOpacityChange={setPopOutOpacity} status={status} position={popOutPosition} onPositionChange={setPopOutPosition} onStartPause={handleStartPause} onStop={handleStop} />
            )}
        </>
    );
}

// --- From index.tsx ---
const rootElement = document.getElementById('root');
if (!rootElement) {
  throw new Error("Could not find root element to mount to");
}

const root = ReactDOM.createRoot(rootElement);
root.render(
  <StrictMode>
    <App />
  </StrictMode>
);

    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>